// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js required models
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String    @default("student") // student, admin
  isFrozen      Boolean   @default(false) // For admin freeze/unfreeze functionality
  profileVerified Boolean @default(false) // Super admin verified profile
  sessionVersion Int       @default(0) // For JWT invalidation when profile changes
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  accounts      Account[]
  sessions      Session[]
  enrollments   Enrollment[]
  payments      Payment[]

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// Course management models
model Course {
  id                    String   @id @default(cuid())
  title                 String
  description           String
  image                 String?
  videoUrl              String?  // Course intro/promo video (YouTube URL)
  price                 Float    @default(0)
  isPaid                Boolean  @default(false)
  isPublished           Boolean  @default(false)
  category              String?
  level                 String?  // beginner, intermediate, advanced
  duration              String?  // e.g., "10 hours"
  accessDurationMonths  Int      @default(6) // Course access duration in months
  
  // Live course fields
  courseType            String   @default("recorded") // recorded, live
  meetingLink           String?  // Zoom, Google Meet, Teams, etc.
  meetingPlatform       String?  // zoom, google-meet, teams, custom
  scheduledStartTime    DateTime? // When the live session starts
  scheduledEndTime      DateTime? // When the live session ends
  isRecurring           Boolean  @default(false) // Is this a recurring live session
  recurringSchedule     String?  // Cron expression or schedule description
  
  // Course features/benefits (What's included)
  features              String?  // JSON array of course features/benefits
  
  // Course overview/learning objectives
  whatYouWillLearn      String?  // What students will learn (multiline text or JSON)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  isDeleted             Boolean  @default(false)

  lessons     Lesson[]
  enrollments Enrollment[]
  payments    Payment[]

  @@index([isPublished])
  @@index([category])
  @@index([createdAt])
  @@index([courseType])
  @@index([scheduledStartTime])
}

model Lesson {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  content     String   // Rich text content
  videoUrl    String?
  duration    String?
  order       Int
  isFree      Boolean  @default(false) // Some lessons can be free previews
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress    LessonProgress[]
  
  @@index([courseId])
  @@index([order])
}

model Enrollment {
  id          String   @id @default(cuid())
  userId      String
  courseId    String
  enrolledAt  DateTime @default(now())
  expiresAt   DateTime? // For time-limited access
  progress    Int      @default(0) // 0-100
  completed   Boolean  @default(false)
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([courseId])
  @@index([enrolledAt])
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
}

model LessonProgress {
  id          String   @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean  @default(false)
  watchTime   Int      @default(0) // in seconds
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
}

model Payment {
  id              String   @id @default(cuid())
  userId          String
  courseId        String
  amount          Float
  currency        String   @default("usd")
  status          String   // pending, completed, failed, refunded
  stripePaymentId String?  @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Mentor {
  id              String   @id @default(cuid())
  name            String
  role            String   // e.g., "Learning Path Designer", "Senior Educator"
  company         String?  // e.g., "Independent Educator"
  bio             String   // Short bio/introduction
  image           String?  // Profile image URL
  expertise       String   // Areas of expertise
  experience      String?  // Years of experience or description
  achievements    String?  // Key achievements (JSON array or comma-separated)
  socialLinks     String?  // Social media links (JSON object)
  isActive        Boolean  @default(true)
  displayOrder    Int      @default(0) // For sorting mentors
  totalStudents   Int      @default(0)
  totalCourses    Int      @default(0)
  
  @@index([isActive, displayOrder])
  rating          Float    @default(5.0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Message {
  id          String   @id @default(cuid())
  senderId    String
  receiverId  String
  content     String
  createdAt   DateTime @default(now())
  read        Boolean  @default(false)

  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

model CheatSheet {
  id          String   @id @default(cuid())
  title       String
  description String?
  fileUrl     String   // URL to the cheat sheet file
  category    String?  // e.g., "JavaScript", "React", "Database"
  tags        String?  // JSON array of tags
  isActive    Boolean  @default(true)
  downloadCount Int    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isActive])
}

model SoftwareLink {
  id          String   @id @default(cuid())
  name        String
  description String?
  url         String   // Link to the software/tool
  category    String?  // e.g., "Development", "Design", "Productivity"
  tags        String?  // JSON array of tags
  isActive    Boolean  @default(true)
  clickCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isActive])
}
